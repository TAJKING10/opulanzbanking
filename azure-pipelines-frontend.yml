trigger:
  branches:
    include:
      - main  # <-- updated to main branch

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: frontend-env-vars

steps:
# ------------------------------
# 1️⃣ Deletes old artifacts before build
# ------------------------------
  - script: |
      rm -rf .next
      rm -rf out
      rm -rf build_output
    displayName: 'Clean previous build artifacts'

# ------------------------------
# 2️⃣ Install Node.js
# ------------------------------
  - task: NodeTool@0
    inputs:
      versionSpec: '22.x'
    displayName: 'Use Node.js 22'

# ------------------------------
# 3️⃣ Install dependencies (CI)
# ------------------------------
  - script: |
      npm ci
    displayName: 'Install dependencies'

# ------------------------------
# 4️⃣ Build Next.js project
# ------------------------------
  - script: |
      npm run build
    displayName: 'Build Next.js'

# ------------------------------
# 5️⃣ Create artifact ZIP WITHOUT node_modules
# ------------------------------
  - task: ArchiveFiles@2
    displayName: 'Archive build output for deployment'
    inputs:
      rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/app.zip'
      replaceExistingArchive: true
      exclude: |
        **/node_modules/**
        **/node_modules
        node_modules
        node_modules/**
        build_output/**
        .git/**
        .next/cache/**

# ------------------------------
# 6️⃣ Publish artifact
# ------------------------------
  - publish: $(Build.ArtifactStagingDirectory)/app.zip
    artifact: drop
    displayName: 'Publish Artifact'

# ------------------------------
# 7️⃣ Deploy to Azure App Service
# Oryx will take over runtime
# ------------------------------
  - task: AzureWebApp@1
    inputs:
      azureSubscription: 'Azure-Service-Connection'
      appName: 'rg-opulanz-frontend'
      package: '$(Pipeline.Workspace)/drop/app.zip'
    displayName: 'Deploy to Azure App Service'
