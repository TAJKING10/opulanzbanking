trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: frontend-env-vars

steps:
# 1️⃣ Use Node 22
- task: NodeTool@0
  inputs:
    versionSpec: '22.x'
  displayName: 'Use Node.js 22'

# 2️⃣ Install dependencies (runtime + build) and build Next.js
- script: |
    npm ci
    npm run build
  displayName: 'Install dependencies and build frontend'

# 3️⃣ Prepare deployment folder (do NOT include node_modules)
- script: |
    rm -rf deploy
    mkdir deploy
    cp -R .next deploy/
    cp -R public deploy/
    cp package.json deploy/
    cp package-lock.json deploy/
    touch deploy/.skipOryxBuild
  displayName: 'Prepare deploy folder'

# 4️⃣ Archive deployment folder
- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: 'deploy'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/frontend.zip'
    replaceExistingArchive: true
  displayName: 'Archive deploy folder'

# 5️⃣ Publish artifact for reuse in other pipelines/environments
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)/frontend.zip'
    ArtifactName: 'frontend'
    publishLocation: 'Container'
  displayName: 'Publish frontend artifact'

# 6️⃣ Deploy to Azure App Service using Oryx runtime
- task: AzureWebApp@1
  inputs:
    azureSubscription: 'Azure-Service-Connection'
    appName: 'rg-opulanz-frontend'
    package: '$(Build.ArtifactStagingDirectory)/frontend.zip'
    enableCustomDeployment: true
    removeAdditionalFilesFlag: true   # Deletes old artifacts before deployment
  displayName: 'Deploy to App Service'
