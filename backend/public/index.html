<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opulanz Banking - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .status-card:hover {
            transform: translateY(-5px);
        }

        .status-card h3 {
            color: #667eea;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .status-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }

        .status-card .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 10px;
        }

        .status-online {
            background: #10b981;
            color: white;
        }

        .status-pending {
            background: #f59e0b;
            color: white;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .narvi-account {
            background: linear-gradient(135deg, #b59354 0%, #886844 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .narvi-account h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .narvi-account .iban {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            letter-spacing: 2px;
        }

        .narvi-account .balance {
            font-size: 36px;
            font-weight: bold;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .applications-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .applications-table th {
            background: #f3f4f6;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
        }

        .applications-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .applications-table tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-submitted {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .log-container {
            background: #1f2937;
            color: #10b981;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 2px solid #10b981;
            padding-left: 10px;
        }

        .log-success {
            color: #10b981;
        }

        .log-error {
            color: #ef4444;
        }

        .log-info {
            color: #60a5fa;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .transaction-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .transaction-item .amount {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .transaction-item .status {
            float: right;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-done {
            background: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üè¶ Opulanz Banking - Admin Panel</h1>
            <p>Backend Management & Monitoring Dashboard</p>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-card">
                <h3>Backend Status</h3>
                <div class="value" id="backend-status">‚óè</div>
                <span class="status status-online" id="backend-badge">ONLINE</span>
            </div>
            <div class="status-card">
                <h3>Database</h3>
                <div class="value" id="db-status">‚óè</div>
                <span class="status status-online" id="db-badge">CONNECTED</span>
            </div>
            <div class="status-card">
                <h3>Narvi API</h3>
                <div class="value" id="narvi-status">‚óè</div>
                <span class="status status-online" id="narvi-badge">ACTIVE</span>
            </div>
            <div class="status-card">
                <h3>Applications</h3>
                <div class="value" id="app-count">0</div>
                <span class="status status-online">TOTAL</span>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Left Column -->
            <div>
                <!-- Narvi Account -->
                <div class="panel">
                    <h2>üí≥ Narvi Account</h2>
                    <div class="narvi-account" id="narvi-account">
                        <h3>Live Business Account</h3>
                        <div class="iban" id="account-iban">Loading...</div>
                        <div class="balance" id="account-balance">‚Ç¨0.00</div>
                    </div>
                    <button class="btn" onclick="refreshAccount()">üîÑ Refresh Balance</button>
                    <button class="btn btn-success" onclick="testTransfer()">üí∏ Test Transfer</button>
                </div>

                <!-- Quick Actions -->
                <div class="panel">
                    <h2>‚ö° Quick Actions</h2>
                    <button class="btn" onclick="runDemo()">üé¨ Run Complete Demo</button>
                    <button class="btn" onclick="testVOP()">‚úÖ Test VOP Flow</button>
                    <button class="btn" onclick="checkStatus()">üìä Check Status</button>
                    <button class="btn btn-success" onclick="refreshAll()">üîÑ Refresh All</button>
                </div>
            </div>

            <!-- Right Column -->
            <div>
                <!-- Recent Applications -->
                <div class="panel">
                    <h2>üìã Recent Applications</h2>
                    <div id="applications-list">
                        <div class="loading"></div> Loading applications...
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="panel">
                    <h2>üí∞ Recent Transactions</h2>
                    <div id="transactions-list">
                        <div class="loading"></div> Loading transactions...
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="panel">
            <h2>üìú Activity Log</h2>
            <div class="log-container" id="activity-log">
                <div class="log-entry log-info">[INFO] Admin panel initialized</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000';
        let accountData = null;

        // Log function
        function log(message, type = 'info') {
            const logContainer = document.getElementById('activity-log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.insertBefore(entry, logContainer.firstChild);

            // Keep only last 50 entries
            if (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Check backend health
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();

                document.getElementById('backend-status').textContent = '‚úì';
                document.getElementById('backend-status').style.color = '#10b981';
                document.getElementById('backend-badge').textContent = 'ONLINE';

                log('Backend health check: OK', 'success');
                return true;
            } catch (error) {
                document.getElementById('backend-status').textContent = '‚úó';
                document.getElementById('backend-status').style.color = '#ef4444';
                document.getElementById('backend-badge').textContent = 'OFFLINE';
                document.getElementById('backend-badge').className = 'status status-pending';

                log('Backend health check failed: ' + error.message, 'error');
                return false;
            }
        }

        // Load Narvi account
        async function loadAccount() {
            try {
                log('Fetching Narvi account...', 'info');

                // Note: This would need to be proxied through your backend
                // For now, we'll show cached data

                const iban = 'FI1879600179463555';
                const balance = 869.11;

                document.getElementById('account-iban').textContent = iban;
                document.getElementById('account-balance').textContent = `‚Ç¨${balance.toFixed(2)}`;

                document.getElementById('narvi-status').textContent = '‚úì';
                document.getElementById('narvi-status').style.color = '#10b981';

                log(`Account loaded: ${iban} - ‚Ç¨${balance.toFixed(2)}`, 'success');

                accountData = { iban, balance };
                return accountData;
            } catch (error) {
                log('Failed to load account: ' + error.message, 'error');
                document.getElementById('narvi-status').textContent = '‚úó';
                document.getElementById('narvi-status').style.color = '#ef4444';
            }
        }

        // Load applications
        async function loadApplications() {
            try {
                log('Loading applications...', 'info');

                const response = await fetch(`${API_BASE}/api/applications?limit=5`);
                const data = await response.json();

                if (data.success) {
                    const count = data.pagination?.total || data.data.length;
                    document.getElementById('app-count').textContent = count;

                    const listHtml = data.data.map(app => `
                        <div class="transaction-item">
                            <div>
                                <strong>${app.type.toUpperCase()}</strong> -
                                Application #${app.id}
                                <span class="status badge-${app.status}">${app.status.toUpperCase()}</span>
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                ${app.payload?.firstName || app.payload?.companyName || 'N/A'} -
                                ${new Date(app.created_at).toLocaleDateString()}
                            </div>
                        </div>
                    `).join('');

                    document.getElementById('applications-list').innerHTML = listHtml || '<p>No applications yet</p>';

                    log(`Loaded ${data.data.length} applications`, 'success');
                } else {
                    document.getElementById('applications-list').innerHTML = '<p>Failed to load applications</p>';
                    log('Failed to load applications', 'error');
                }
            } catch (error) {
                document.getElementById('applications-list').innerHTML = '<p>Error loading applications</p>';
                log('Error loading applications: ' + error.message, 'error');
            }
        }

        // Load transactions (placeholder - needs backend endpoint)
        async function loadTransactions() {
            try {
                log('Loading transactions...', 'info');

                // Placeholder data
                const transactions = [
                    { id: '8N5M...', amount: 0, currency: 'EUR', status: 'DONE', type: 'FEE' },
                    { id: 'OG7N...', amount: 449, currency: 'EUR', status: 'DONE', type: 'DEBIT' },
                    { id: 'ES4B...', amount: 0, currency: 'EUR', status: 'DONE', type: 'FEE' },
                    { id: 'MS9R...', amount: 99910, currency: 'EUR', status: 'DONE', type: 'CREDIT' }
                ];

                const listHtml = transactions.map(tx => `
                    <div class="transaction-item">
                        <div>
                            <span class="amount">‚Ç¨${(tx.amount / 100).toFixed(2)}</span>
                            <span class="status status-${tx.status.toLowerCase()}">${tx.status}</span>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            ${tx.type} - TX: ${tx.id}
                        </div>
                    </div>
                `).join('');

                document.getElementById('transactions-list').innerHTML = listHtml;

                log(`Loaded ${transactions.length} transactions`, 'success');
            } catch (error) {
                document.getElementById('transactions-list').innerHTML = '<p>Error loading transactions</p>';
                log('Error loading transactions: ' + error.message, 'error');
            }
        }

        // Quick actions
        function refreshAccount() {
            log('Refreshing account data...', 'info');
            loadAccount();
        }

        function testTransfer() {
            log('Opening transfer test...', 'info');
            alert('To test transfers, run: node backend/test-vop-flow.js in terminal');
        }

        function runDemo() {
            log('To run demo, execute: node backend/test-complete-demo.js', 'info');
            alert('Run this command in terminal:\ncd backend\nnode test-complete-demo.js');
        }

        function testVOP() {
            log('To test VOP, execute: node backend/test-vop-flow.js', 'info');
            alert('Run this command in terminal:\ncd backend\nnode test-vop-flow.js');
        }

        function checkStatus() {
            log('To check status, execute: node backend/test-complete-narvi-status.js', 'info');
            alert('Run this command in terminal:\nnode backend/test-complete-narvi-status.js');
        }

        function refreshAll() {
            log('Refreshing all data...', 'info');
            checkHealth();
            loadAccount();
            loadApplications();
            loadTransactions();
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            log('Initializing admin panel...', 'info');
            checkHealth();
            loadAccount();
            loadApplications();
            loadTransactions();

            // Auto-refresh every 30 seconds
            setInterval(() => {
                checkHealth();
                loadApplications();
            }, 30000);

            log('Admin panel ready!', 'success');
        });
    </script>
</body>
</html>
